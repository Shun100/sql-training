# サブクエリ

- サブクエリは記述する場所によって動きが異なる
  1. SELECT句
  2. WHERE句
  3. FROM句

## 1. SELECT句に置いた場合
- ポイント
  - サブクエリは「列を計算するための式」として機能する
  - サブクエリはスカラーしか返せない

``` psql
外側テーブル: animal
+---------+
| name    |
+---------+
| サル    |
| コアラ  |
| キリン  |
+---------+

SELECT a.name,
  (SELECT num FROM zooB z WHERE z.name = a.name) AS zoo_num
FROM animal a;

処理の流れ：
① 外側の1行目（サル）を見てサブクエリを評価 → numを取得
② 外側の2行目（コアラ）を見てサブクエリを評価 → numを取得
③ 外側の3行目（キリン）を見てサブクエリを評価 → numを取得

結果は列値として追加される：
+---------+---------+
| name    | zoo_num |
+---------+---------+
| サル    | 22      |
| コアラ  | 2       |
| キリン  | 3       |
+---------+---------+
```

## 2. WHERE句に置いた場合
- ポイント
  - サブクエリは「行を残す or 捨てる」条件として使う
  - 複数行返すサブクエリでも`EXISTS`や`IN`からOK (最終的にはbooleanのスカラーになるため)

``` psql
SELECT * 
FROM animal a
WHERE EXISTS (
  SELECT 1 FROM zooB z WHERE z.name = a.name
);

処理の流れ：
① 外側の1行目（サル）に対してサブクエリ実行 → 行が存在する → TRUE → この行を残す
② 外側の2行目（コアラ）に対してサブクエリ実行 → TRUE → 残す
③ 外側の3行目（チーター）に対してサブクエリ実行 → FALSE → 除外

結果は**外側の行がフィルタリングされる**：
+---------+
| name    |
+---------+
| サル    |
| コアラ  |
| キリン  |
+---------+
```

## 3. FROM句に置いた場合
- ポイント
  - サブクエリは「一時テーブル」を作るために機能する
  - 複数行・複数列はOK
  - サブクエリの結果(=メインクエリの列)にエイリアスをつけると安全

``` psql
SELECT sub.name, sub.num
FROM (
  SELECT name, num FROM zooB WHERE num > 2
) AS sub;

処理の流れ：
① サブクエリを先に実行して一時テーブルを作る
+---------+-----+
| name    | num |
+---------+-----+
| サル    | 22  |
| キリン  | 3   |
+---------+-----+
② 外側のSELECTでこのテーブルを参照して出力

結果：
+---------+-----+
| name    | num |
+---------+-----+
| サル    | 22  |
| キリン  | 3   |
+---------+-----+
```